<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>タスク進捗可視化アプリ</title>
  <!-- Noto Sans JPのGoogle Fonts追加 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 2em;
    }

    label {
      display: block;
      margin-top: 1em;
    }

    .container {
      margin-bottom: 2rem;
    }

    .bar-container {
      width: 300px;
      height: 30px;
      background: #eee;
      border-radius: 5px;
      margin-top: 1em;
      position: relative;
    }

    .bar {
      height: 100%;
      background: #4caf50;
      border-radius: 5px 0 0 5px;
      transition: width 0.3s;
    }

    .bar-label {
      position: absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      color: #222;
      font-weight: bold;
      line-height: 30px;
    }

    .result {
      margin-top: 1em;
      font-size: 1.2em;
    }

    button {
      margin-top: 1.5em;
      background: #f5f5f5;
      color: #222;
      border: 1px solid #bbb;
      border-radius: 4px;
      padding: 0.4em 1.2em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }

    .active-slot {
      background: #1976d2 !important;
      color: #fff !important;
      border-color: #1976d2 !important;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }

    .active-save {
      background: #43a047 !important;
      color: #fff !important;
      border-color: #43a047 !important;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
  </style>
</head>

<body>
  <h1>タスク進捗可視化アプリ</h1>
  <form id="taskForm">
    <div class="container">
      <label>
        開始日:
        <input type="date" id="startDate" required>
      </label>
      <label>
        終了日:
        <input type="date" id="endDate" required>
      </label>
    </div>

    <div class="container">
      <label>
        目標タスク数:
        <input type="number" id="goalTasks" min="1" required>
      </label>
      <label>
        完了タスク数:
        <input type="number" id="doneTasks" min="0" required>
      </label>
    </div>
    <div class="container">
      <label>
        <div id="remainTasks"></div>
      </label>
      <label>
        目標1日タスク数:
        <input type="number" id="targetPerDay" min="1" step="1" required>
      </label>
      <label>
        <div id="predictedEndDate"></div>
      </label>
    </div>

    <div class="container">
      <div class="result" id="tasksPerDay"></div>
      <div class="bar-container">
        <div class="bar" id="progressBar" style="width:0%"></div>
        <span class="bar-label" id="barLabel">0%</span>
      </div>
    </div>

    <div class="container">
      <div>
        <button type="button" id="loadBtn1">読込1</button>
        <button type="button" id="loadBtn2">読込2</button>
        <button type="button" id="loadBtn3">読込3</button>
        <button type="button" id="loadBtn4">読込4</button>
      </div>
      <div>
        <button type="button" class="saveBtn" data-slot="1">保存1</button>
        <button type="button" class="saveBtn" data-slot="2">保存2</button>
        <button type="button" class="saveBtn" data-slot="3">保存3</button>
        <button type="button" class="saveBtn" data-slot="4">保存4</button>
        <button type="button" id="resetAllBtn"
          style="margin-left:1em; background:#e53935; color:#fff;">全スロットリセット</button>
      </div>
    </div>
  </form>

  <script>
    // DOM要素取得
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const goalTasksInput = document.getElementById('goalTasks');
    const doneTasksInput = document.getElementById('doneTasks');
    const tasksPerDayDiv = document.getElementById('tasksPerDay');
    const progressBar = document.getElementById('progressBar');
    const barLabel = document.getElementById('barLabel');
    const saveBtns = document.querySelectorAll('.saveBtn');
    const remainTasksDiv = document.getElementById('remainTasks');
    const targetPerDayInput = document.getElementById('targetPerDay');
    const predictedEndDateDiv = document.getElementById('predictedEndDate');

    // デフォルトで今日の日付をセット
    const today = new Date().toISOString().split('T')[0];
    startDateInput.value = today;

    let currentSlot = 1; // 現在のスロット番号

    // 読込ボタン
    for (let i = 1; i <= 4; i++) {
      document.getElementById('loadBtn' + i).onclick = function () {
        loadSlot(i);
      };
    }

    function updateActiveSlotButton(slot) {
      for (let i = 1; i <= 4; i++) {
        const btn = document.getElementById('loadBtn' + i);
        if (i === slot) {
          btn.classList.add('active-slot');
        } else {
          btn.classList.remove('active-slot');
        }
      }
    }

    function loadSlot(slot) {
      const saved = JSON.parse(localStorage.getItem('taskProgress' + slot));
      if (saved) {
        endDateInput.value = saved.endDate;
        goalTasksInput.value = saved.goalTasks;
        doneTasksInput.value = saved.doneTasks;
        targetPerDayInput.value = saved.targetPerDay ?? '';
      } else {
        endDateInput.value = '';
        goalTasksInput.value = '';
        doneTasksInput.value = '';
        targetPerDayInput.value = '';
      }
      // 開始日は常に今日
      startDateInput.value = today;
      currentSlot = slot;
      updateActiveSlotButton(slot);
      update();
      updateSaveBtnStates();
    }

    // 保存ボタン（4スロット）※開始日は保存しない
    saveBtns.forEach(btn => {
      btn.onclick = function () {
        const slot = btn.getAttribute('data-slot');
        const data = {
          endDate: endDateInput.value,
          goalTasks: goalTasksInput.value,
          doneTasks: doneTasksInput.value,
          targetPerDay: targetPerDayInput.value
        };
        localStorage.setItem('taskProgress' + slot, JSON.stringify(data));
        updateSaveBtnStates();
        alert(`スロット${slot}に保存しました`);
      };
    });

    // 保存ボタンの状態を更新
    function updateSaveBtnStates() {
      saveBtns.forEach(btn => {
        const slot = btn.getAttribute('data-slot');
        const saved = JSON.parse(localStorage.getItem('taskProgress' + slot));
        // 現在の値と保存値が一致していれば色をつける
        if (
          saved &&
          saved.endDate === endDateInput.value &&
          saved.goalTasks === goalTasksInput.value &&
          saved.doneTasks === doneTasksInput.value &&
          saved.targetPerDay === targetPerDayInput.value
        ) {
          btn.classList.add('active-save');
        } else {
          btn.classList.remove('active-save');
        }
      });
    }

    // 入力値が変わったら計算・表示＆保存ボタン状態も更新
    [startDateInput, endDateInput, goalTasksInput, doneTasksInput, targetPerDayInput].forEach(input => {
      input.addEventListener('input', () => {
        update();
        updateSaveBtnStates();
      });
    });

    function update() {
      const start = startDateInput.value;
      const end = endDateInput.value;
      const goal = Number(goalTasksInput.value);
      const done = Number(doneTasksInput.value);
      const targetPerDay = Number(targetPerDayInput.value);

      // 残タスク数の表示
      const remainNum = goal - done;
      remainTasksDiv.innerHTML = `残タスク数: ${remainNum >= 0 && !isNaN(remainNum) ? remainNum : '-'}`;

      // 予想終了日の表示
      let predictedText = '';
      if (targetPerDay > 0 && remainNum > 0 && !isNaN(remainNum)) {
        const daysNeeded = Math.ceil(remainNum / targetPerDay);
        const todayDate = new Date();
        todayDate.setDate(todayDate.getDate() + daysNeeded);
        const yyyy = todayDate.getFullYear();
        const mm = String(todayDate.getMonth() + 1).padStart(2, '0');
        const dd = String(todayDate.getDate()).padStart(2, '0');
        predictedText = `予想終了日: ${yyyy}-${mm}-${dd}（${daysNeeded}日後）`;
      } else {
        predictedText = '予想終了日: -';
      }
      predictedEndDateDiv.innerHTML = predictedText;

      // 日数計算
      let days = 0;
      if (start && end) {
        days = (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24);
      }

      // 1日あたり必要なタスク数
      let perDay = '';
      if (goal && days > 0) {
        const remain = Math.max(goal - done, 0);
        perDay = `1日あたりに必要なタスク数: <b>${(remain / days).toFixed(2)}</b>`;
      } else {
        perDay = '1日あたりに必要なタスク数: -';
      }
      tasksPerDayDiv.innerHTML = perDay;

      // バーグラフ
      let percent = 0;
      if (goal > 0) {
        percent = Math.min((done / goal) * 100, 100);
      }
      progressBar.style.width = percent + '%';
      barLabel.textContent = percent.toFixed(1) + '%';
    }

    // 全スロットリセットボタン
    document.getElementById('resetAllBtn').onclick = function () {
      if (confirm('本当に全てのスロットをリセットしますか？')) {
        for (let i = 1; i <= 4; i++) {
          localStorage.removeItem('taskProgress' + i);
        }
        updateSaveBtnStates();
        alert('全スロットをリセットしました');
      }
    };

    // 初期化時にスロット1をアクティブに
    window.onload = function () {
      loadSlot(1);
    };
  </script>
</body>

</html>